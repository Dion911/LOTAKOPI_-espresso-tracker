<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.webmanifest" />
  <title>Espresso Tracker</title>

  <style>
    :root{
      --bg:#ffffff;
      --ink:#111111;
      --muted:#666666;
      --line:#e7e7e7;
      --card:#ffffff;
      --soft:#f7f7f7;
      --radius:18px;
      --pad:16px;
      --gap:12px;
      --h2:16px;
      --small:12px;
      --big:46px;
      --shadow: 0 8px 30px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg);
      color:var(--ink);
    }
    .app{
      max-width: 440px;
      margin: 0 auto;
      min-height: 100dvh;
      padding: 10px 14px 28px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 2px 8px;
    }
    .title{
      font-size: var(--h2);
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:650;
    }
    .navbtn{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:12px;
      padding:10px 12px;
      font-weight:600;
      cursor:pointer;
    }
    .row{ display:flex; gap: var(--gap); }
    .btn{
      width:100%;
      border:1px solid var(--line);
      background:var(--card);
      border-radius:14px;
      padding:14px 14px;
      font-weight:650;
      cursor:pointer;
    }
    .btn.primary{
      background: var(--ink);
      color: var(--bg);
      border-color: var(--ink);
    }
    .btn.ghost{ background: transparent; }
    .card{
      border:1px solid var(--line);
      background: var(--card);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: var(--shadow);
    }
    .hero{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 240px;
      overflow:hidden;
    }
    .hero img{
      width: 88%;
      max-width: 320px;
      height:auto;
      display:block;
      user-select:none;
      -webkit-user-drag:none;
    }
    .sectionlabel{
      margin: 14px 2px 10px;
      font-size: var(--small);
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
      font-weight:700;
    }
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
    }
    .stat{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      background: var(--card);
    }
    .stat .k{
      font-size: var(--small);
      letter-spacing:.12em;
      text-transform:uppercase;
      color: var(--muted);
      font-weight:700;
    }
    .stat .v{
      margin-top: 10px;
      font-size: var(--big);
      font-weight:750;
      line-height:1;
    }

    .table{
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      background: var(--card);
    }
    .tr{
      display:grid;
      grid-template-columns: 1fr 1.2fr;
      border-top:1px solid var(--line);
    }
    .tr:first-child{ border-top:0; }
    .tr.two{ grid-template-columns: 1fr 1fr; }
    .td{ padding: 14px; font-weight:650; }
    .td.label{
      color: var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size: var(--small);
      font-weight:800;
      background: var(--soft);
      border-right: 1px solid var(--line);
    }
    .mono{ font-feature-settings: "tnum" 1, "ss01" 1; }

    .spacer{ height: 12px; }
    .screen{ display:none; }
    .screen.active{ display:block; }

    /* Cover */
    .cover{ padding-top: 26px; text-align:center; }
    .cover h1{ margin: 10px 0 6px; font-size: 28px; letter-spacing:.01em; }
    .cover p{ margin: 0 0 18px; color: var(--muted); }
    .footerhint{ margin-top: 14px; font-size: 12px; color: var(--muted); }

    /* Form */
    .field{
      width:100%;
      border:1px solid var(--line);
      background: #fff;
      border-radius: 12px;
      padding: 12px 12px;
      font-weight:650;
      font-size: 14px;
      outline:none;
    }
    .field:focus{ border-color:#cfcfcf; }
    .helper{ font-size:12px; color:var(--muted); margin-top:6px; }

    /* Shot list */
    .shotlist{ display:flex; flex-direction:column; gap:10px; }
    .shotitem{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      background: #fff;
    }
    .shotmeta{ display:flex; flex-direction:column; gap:4px; min-width: 0; }
    .shotmeta .a{ font-weight:750; }
    .shotmeta .b{ color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .shotnums{
      text-align:right;
      font-feature-settings: "tnum" 1;
      white-space:nowrap;
      font-weight:700;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
      background: var(--soft);
      margin-right: 8px;
      margin-bottom: 8px;
    }

    /* Bottom sheet */
    .sheet{
      position: fixed;
      inset: 0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      background: rgba(0,0,0,.25);
      padding: 12px;
    }
    .sheet.active{ display:flex; }
    .sheetpanel{
      width:min(440px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 14px;
      max-height: 80dvh;
      overflow:auto;
    }
    .sheethead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .sheettitle{
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size: 12px;
      color: var(--muted);
    }
    .divider{ height:1px; background: var(--line); margin: 12px 0; }
  
    /* Sketch-style boxes for cover */
    .sketchBox{
      border:2px solid #111;
      border-radius: var(--radius);
      background:#fff;
      padding: 14px;
      box-shadow:none;
    }
    .titleCard{
      font-weight:900;
      letter-spacing:.04em;
      text-transform:uppercase;
      text-align:center;
    }
    .heroCard{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 12px;
    }
    .heroCard img{ width: 88%; max-width: 320px; height:auto; display:block; }
    </style>
</head>

<body>
  <main class="app">

    <!-- COVER -->
    <section class="screen active" id="screen-cover" aria-label="Cover">
      <div class="cover">
        <div class="sketchBox titleCard">LOTA ESPRESSO TRACKER</div>

        <div class="spacer"></div>

        <div class="sketchBox heroCard" style="min-height:320px">
          <img src="assets/helmet-girl.png" alt="Helmet Girl cover illustration">
        </div>

        <div class="spacer"></div>
        <button class="btn primary" data-go="dashboard">LET'S STARTED!</button>

        <div class="footerhint">Offline-ready • v0.2</div>
      </div>
</section>

    <!-- DASHBOARD -->
    <section class="screen" id="screen-dashboard" aria-label="Dashboard">
      <div class="topbar">
        <div class="title">ESPRESSO TRACKER</div>
        <button class="navbtn" data-go="cover" aria-label="Back to cover">⌂</button>
      </div>

      <div class="row">
        <button class="btn" id="btn-export">Export</button>
        <button class="btn" id="btn-import">Import</button>
      </div>

      <input id="file-import" type="file" accept="application/json" hidden />

      <div class="spacer"></div>

      <div class="card hero">
        <img src="assets/portafilter.png" alt="Portafilter illustration">
      </div>

      <div class="sectionlabel">SUMMARY (LAST 7 DAYS)</div>

      <div class="stats">
        <div class="stat">
          <div class="k">Shots</div>
          <div class="v" id="stat-shots">0</div>
        </div>
        <div class="stat">
          <div class="k">Bean Types</div>
          <div class="v" id="stat-beans">0</div>
        </div>
        <div class="stat">
          <div class="k">Good</div>
          <div class="v" id="stat-good">0%</div>
        </div>
        <div class="stat">
          <div class="k">Ave Time</div>
          <div class="v" id="stat-avg">—</div>
        </div>
      </div>

      <div class="sectionlabel">RECENT SHOTS</div>
      <div class="shotlist" id="shotlist"></div>
      <div class="helper" id="shotlist-empty" style="display:none">No shots yet. Pull one ☕</div>

      <div class="spacer"></div>
      <button class="btn primary" data-go="newshot">+ New Shot</button>
    </section>

    <!-- NEW SHOT -->
    <section class="screen" id="screen-newshot" aria-label="New Shot">
      <div class="topbar">
        <button class="navbtn" data-go="dashboard" aria-label="Back">←</button>
        <div class="title">NEW SHOT!</div>
        <div style="width:44px"></div>
      </div>

      <div class="card hero">
        <img src="assets/portafilter.png" alt="Portafilter illustration">
      </div>

      <div class="spacer"></div>

      <div class="table" role="table" aria-label="Shot Meta">
        <div class="tr">
          <div class="td label">Today</div>
          <div class="td mono">
            <input class="field mono" id="f-date" type="date" />
          </div>
        </div>
        <div class="tr">
          <div class="td label">Bean</div>
          <div class="td mono">
            <input class="field mono" id="f-bean" placeholder="MT APO" />
          </div>
        </div>
        <div class="tr">
          <div class="td label">Type</div>
          <div class="td mono">
            <input class="field mono" id="f-type" placeholder="ARABICA" />
          </div>
        </div>
        <div class="tr">
          <div class="td label">Roast</div>
          <div class="td mono">
            <input class="field mono" id="f-roast" placeholder="MEDIUM" />
          </div>
        </div>
      </div>

      <div class="sectionlabel">DETAILS</div>

      <div class="table" role="table" aria-label="Shot Details">
        <div class="tr two">
          <div class="td mono">
            GRIND
            <div class="spacer"></div>
            <input class="field mono" id="f-grind" inputmode="numeric" placeholder="35" />
          </div>
          <div class="td mono">
            DOSE (g)
            <div class="spacer"></div>
            <input class="field mono" id="f-dose" inputmode="decimal" placeholder="18" />
          </div>
        </div>
        <div class="tr two">
          <div class="td mono">
            YIELD (ml)
            <div class="spacer"></div>
            <input class="field mono" id="f-yield" inputmode="decimal" placeholder="30" />
          </div>
          <div class="td mono">
            TIME (s)
            <div class="spacer"></div>
            <input class="field mono" id="f-time" inputmode="decimal" placeholder="25" />
          </div>
        </div>
      </div>

      <div class="sectionlabel">RATING</div>
      <div class="row">
        <select class="field mono" id="f-rating" aria-label="Rating">
          <option value="5">★★★★★ (Great)</option>
          <option value="4" selected>★★★★☆ (Good)</option>
          <option value="3">★★★☆☆ (Okay)</option>
          <option value="2">★★☆☆☆ (Off)</option>
          <option value="1">★☆☆☆☆ (Bad)</option>
        </select>
      </div>

      <div class="spacer"></div>
      <button class="btn primary" id="btn-save">Save Shot</button>
      <div class="spacer"></div>
      <button class="btn ghost" id="btn-week">Week Summary</button>
    </section>

  </main>

  <!-- Week Summary Sheet -->
  <div class="sheet" id="week-sheet" role="dialog" aria-modal="true" aria-label="Week Summary">
    <div class="sheetpanel">
      <div class="sheethead">
        <div class="sheettitle">WEEK SUMMARY (LAST 7 DAYS)</div>
        <button class="navbtn" id="sheet-close" aria-label="Close">✕</button>
      </div>

      <div id="week-badges"></div>
      <div class="divider"></div>

      <div class="stats" style="grid-template-columns:1fr 1fr">
        <div class="stat">
          <div class="k">Shots</div>
          <div class="v" id="wk-shots">0</div>
        </div>
        <div class="stat">
          <div class="k">Avg Time</div>
          <div class="v" id="wk-avgtime">—</div>
        </div>
        <div class="stat">
          <div class="k">Avg Dose</div>
          <div class="v" id="wk-avgdose">—</div>
        </div>
        <div class="stat">
          <div class="k">Avg Yield</div>
          <div class="v" id="wk-avgyield">—</div>
        </div>
      </div>

      <div class="sectionlabel">BEANS USED</div>
      <div id="wk-beans" class="helper">—</div>

      <div class="sectionlabel">RECENT (WEEK)</div>
      <div class="shotlist" id="wk-list"></div>
    </div>
  </div>

  <script>
    /* -----------------------------
      Storage + Model
    ------------------------------ */
    const STORAGE_KEY = "espresso_tracker_v0_2";

    function loadStore(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { shots: [] };
        const parsed = JSON.parse(raw);
        if(!parsed || !Array.isArray(parsed.shots)) return { shots: [] };
        return parsed;
      }catch(e){
        return { shots: [] };
      }
    }

    function saveStore(store){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
    }

    function uid(){
      return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    }

    function toISODate(d){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function daysAgoISO(n){
      const d = new Date();
      d.setHours(0,0,0,0);
      d.setDate(d.getDate() - n);
      return toISODate(d);
    }

    function inLast7Days(isoDate){
      const min = daysAgoISO(6);
      return isoDate >= min && isoDate <= toISODate(new Date());
    }

    function num(v){
      const x = Number(v);
      return Number.isFinite(x) ? x : null;
    }

    function fmtAvg(v, suffix){
      if(v == null) return "—";
      const rounded = Math.round(v * 10) / 10;
      return (rounded % 1 === 0 ? String(rounded.toFixed(0)) : String(rounded)) + (suffix || "");
    }

    function weekShots(store){
      return store.shots
        .filter(s => s.date && inLast7Days(s.date))
        .sort((a,b) => (b.date+a.createdAt).localeCompare(a.date+b.createdAt));
    }

    /* -----------------------------
      Router
    ------------------------------ */
    const screens = {
      cover: document.getElementById('screen-cover'),
      dashboard: document.getElementById('screen-dashboard'),
      newshot: document.getElementById('screen-newshot'),
    };

    function show(name){
      Object.values(screens).forEach(s => s.classList.remove('active'));
      (screens[name] || screens.cover).classList.add('active');
      history.replaceState({}, "", "#" + name);
      if(name === "dashboard") renderAll();
      if(name === "newshot") seedNewShotForm();
    }

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-go]');
      if(!btn) return;
      show(btn.dataset.go);
    });

    /* -----------------------------
      Elements
    ------------------------------ */
    const elStats = {
      shots: document.getElementById("stat-shots"),
      beans: document.getElementById("stat-beans"),
      good: document.getElementById("stat-good"),
      avg: document.getElementById("stat-avg"),
    };

    const elShotList = document.getElementById("shotlist");
    const elShotEmpty = document.getElementById("shotlist-empty");

    const form = {
      date: document.getElementById("f-date"),
      bean: document.getElementById("f-bean"),
      type: document.getElementById("f-type"),
      roast: document.getElementById("f-roast"),
      grind: document.getElementById("f-grind"),
      dose: document.getElementById("f-dose"),
      yield: document.getElementById("f-yield"),
      time: document.getElementById("f-time"),
      rating: document.getElementById("f-rating"),
    };

    /* -----------------------------
      Render: Dashboard
    ------------------------------ */
    function renderDashboard(store){
      const wk = weekShots(store);

      const shotsCount = wk.length;
      const beansSet = new Set(wk.map(s => (s.bean||"").trim().toUpperCase()).filter(Boolean));
      const goodCount = wk.filter(s => (s.rating ?? 0) >= 4).length;

      const times = wk.map(s => s.time).filter(v => typeof v === "number");
      const avgTime = times.length ? (times.reduce((a,b)=>a+b,0) / times.length) : null;

      elStats.shots.textContent = String(shotsCount);
      elStats.beans.textContent = String(beansSet.size);
      elStats.good.textContent = shotsCount ? (Math.round((goodCount/shotsCount)*100) + "%") : "0%";
      elStats.avg.textContent = avgTime == null ? "—" : fmtAvg(avgTime, "s");

      const recent = store.shots
        .slice()
        .sort((a,b)=> (b.date+b.createdAt).localeCompare(a.date+a.createdAt))
        .slice(0, 10);

      elShotList.innerHTML = "";
      if(recent.length === 0){
        elShotEmpty.style.display = "block";
      }else{
        elShotEmpty.style.display = "none";
        recent.forEach(s => elShotList.appendChild(shotItemNode(s)));
      }
    }

    function stars(r){
      const n = Math.max(1, Math.min(5, Number(r||0)));
      return "★".repeat(n) + "☆".repeat(5-n);
    }

    function shotItemNode(s){
      const left = document.createElement("div");
      left.className = "shotmeta";

      const a = document.createElement("div");
      a.className = "a";
      a.textContent = `${s.date || "—"} • ${stars(s.rating||0)}`;

      const b = document.createElement("div");
      b.className = "b";
      const bean = (s.bean||"").trim() || "Bean";
      const type = (s.type||"").trim();
      const roast = (s.roast||"").trim();
      b.textContent = [bean, type, roast].filter(Boolean).join(" / ");

      left.appendChild(a);
      left.appendChild(b);

      const right = document.createElement("div");
      right.className = "shotnums";
      const g = (s.grind!=null) ? `G${s.grind}` : "G—";
      const dt = (s.dose!=null) ? `${s.dose}g` : "—g";
      const y = (s.yield!=null) ? `${s.yield}ml` : "—ml";
      const t = (s.time!=null) ? `${s.time}s` : "—s";
      right.textContent = `${g} • ${dt} • ${y} • ${t}`;

      const wrap = document.createElement("div");
      wrap.className = "shotitem";
      wrap.appendChild(left);
      wrap.appendChild(right);

      // Tap to edit
      wrap.addEventListener("click", () => openEdit(s.id));

      wrap.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        if(confirm("Delete this shot?")){
          const store = loadStore();
          store.shots = store.shots.filter(x => x.id !== s.id);
          saveStore(store);
          renderAll();
        }
      });

      return wrap;
    }

    /* -----------------------------
      New Shot: Seed + Save
    ------------------------------ */
    function seedNewShotForm(){
      const todayISO = toISODate(new Date());
      form.date.value = todayISO;

      if(!form.bean.value) form.bean.value = "MT APO";
      if(!form.type.value) form.type.value = "ARABICA";
      if(!form.roast.value) form.roast.value = "MEDIUM";
      if(!form.grind.value) form.grind.value = "35";
      if(!form.dose.value) form.dose.value = "18";
      if(!form.yield.value) form.yield.value = "30";
      if(!form.time.value) form.time.value = "25";
      if(!form.rating.value) form.rating.value = "4";
    }

    function saveShotFromForm(){
      const s = {
        id: uid(),
        createdAt: new Date().toISOString(),
        date: form.date.value || toISODate(new Date()),
        bean: (form.bean.value || "").trim(),
        type: (form.type.value || "").trim(),
        roast: (form.roast.value || "").trim(),
        grind: num(form.grind.value),
        dose: num(form.dose.value),
        yield: num(form.yield.value),
        time: num(form.time.value),
        rating: num(form.rating.value) || 4
      };

      const store = loadStore();
      store.shots.push(s);
      saveStore(store);
    }

    document.getElementById("btn-save").addEventListener("click", () => {
      saveShotFromForm();
      show("dashboard");
    });

    /* -----------------------------
      Week Summary Sheet
    ------------------------------ */
    const sheet = document.getElementById("week-sheet");
    const sheetClose = document.getElementById("sheet-close");
    const btnWeek = document.getElementById("btn-week");

    const wk = {
      badges: document.getElementById("week-badges"),
      shots: document.getElementById("wk-shots"),
      avgtime: document.getElementById("wk-avgtime"),
      avgdose: document.getElementById("wk-avgdose"),
      avgyield: document.getElementById("wk-avgyield"),
      beans: document.getElementById("wk-beans"),
      list: document.getElementById("wk-list")
    };

    function openSheet(){
      renderWeekSheet(loadStore());
      sheet.classList.add("active");
    }
    function closeSheet(){
      sheet.classList.remove("active");
    }

    btnWeek.addEventListener("click", openSheet);
    sheetClose.addEventListener("click", closeSheet);
    sheet.addEventListener("click", (e) => {
      if(e.target === sheet) closeSheet();
    });

    function renderWeekSheet(store){
      const w = weekShots(store);

      const times = w.map(s=>s.time).filter(v=>typeof v==="number");
      const doses = w.map(s=>s.dose).filter(v=>typeof v==="number");
      const yields = w.map(s=>s.yield).filter(v=>typeof v==="number");

      const avgTime = times.length ? times.reduce((a,b)=>a+b,0)/times.length : null;
      const avgDose = doses.length ? doses.reduce((a,b)=>a+b,0)/doses.length : null;
      const avgYield = yields.length ? yields.reduce((a,b)=>a+b,0)/yields.length : null;

      const beans = Array.from(new Set(w.map(s => (s.bean||"").trim().toUpperCase()).filter(Boolean)));

      const goodCount = w.filter(s => (s.rating ?? 0) >= 4).length;
      const goodPct = w.length ? Math.round((goodCount/w.length)*100) : 0;

      wk.badges.innerHTML = "";
      wk.badges.appendChild(makePill(`Good: ${goodPct}%`));
      wk.badges.appendChild(makePill(`Beans: ${beans.length}`));
      wk.badges.appendChild(makePill(`Shots: ${w.length}`));

      wk.shots.textContent = String(w.length);
      wk.avgtime.textContent = avgTime == null ? "—" : fmtAvg(avgTime, "s");
      wk.avgdose.textContent = avgDose == null ? "—" : fmtAvg(avgDose, "g");
      wk.avgyield.textContent = avgYield == null ? "—" : fmtAvg(avgYield, "ml");

      wk.beans.textContent = beans.length ? beans.join(", ") : "—";

      wk.list.innerHTML = "";
      w.slice(0, 12).forEach(s => wk.list.appendChild(shotItemNode(s)));
    }

    function makePill(text){
      const span = document.createElement("span");
      span.className = "pill";
      span.textContent = text;
      return span;
    }

    /* -----------------------------
      Export / Import
    ------------------------------ */
    const btnExport = document.getElementById("btn-export");
    const btnImport = document.getElementById("btn-import");
    const fileImport = document.getElementById("file-import");

    btnExport.addEventListener("click", () => {
      const store = loadStore();
      const payload = {
        app: "espresso-tracker",
        version: "0.2",
        exportedAt: new Date().toISOString(),
        ...store
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "espresso-tracker.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener("click", () => fileImport.click());

    fileImport.addEventListener("change", async () => {
      const file = fileImport.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);

        if(!data || !Array.isArray(data.shots)){
          alert("Invalid file: missing shots array.");
          return;
        }

        const normalized = data.shots.map(s => ({
          id: s.id || uid(),
          createdAt: s.createdAt || new Date().toISOString(),
          date: s.date || toISODate(new Date()),
          bean: (s.bean || "").trim(),
          type: (s.type || "").trim(),
          roast: (s.roast || "").trim(),
          grind: num(s.grind),
          dose: num(s.dose),
          yield: num(s.yield),
          time: num(s.time),
          rating: num(s.rating) || 4
        }));

        const store = { shots: normalized };
        saveStore(store);
        alert("Import complete.");
        renderAll();
      }catch(e){
        alert("Could not import. File might be corrupted.");
      }finally{
        fileImport.value = "";
      }
    });

    
    /* -----------------------------
      Edit Shot (tap Recent Shot)
    ------------------------------ */
    const editSheet = document.getElementById("edit-sheet");
    const editClose = document.getElementById("edit-close");
    const editSave = document.getElementById("edit-save");
    const editDelete = document.getElementById("edit-delete");

    const edit = {
      date: document.getElementById("e-date"),
      bean: document.getElementById("e-bean"),
      type: document.getElementById("e-type"),
      roast: document.getElementById("e-roast"),
      grind: document.getElementById("e-grind"),
      dose: document.getElementById("e-dose"),
      yield: document.getElementById("e-yield"),
      time: document.getElementById("e-time"),
      rating: document.getElementById("e-rating")
    };

    let editingId = null;

    function openEdit(id){
      const store = loadStore();
      const s = store.shots.find(x => x.id === id);
      if(!s) return;
      editingId = id;

      edit.date.value = s.date || toISODate(new Date());
      edit.bean.value = s.bean || "";
      edit.type.value = s.type || "";
      edit.roast.value = s.roast || "";
      edit.grind.value = (s.grind ?? "");
      edit.dose.value = (s.dose ?? "");
      edit.yield.value = (s.yield ?? "");
      edit.time.value = (s.time ?? "");
      edit.rating.value = String(s.rating ?? 4);

      editSheet.classList.add("active");
    }

    function closeEdit(){
      editSheet.classList.remove("active");
      editingId = null;
    }

    editClose.addEventListener("click", closeEdit);
    editSheet.addEventListener("click", (e) => { if(e.target === editSheet) closeEdit(); });

    editSave.addEventListener("click", () => {
      if(!editingId) return;
      const store = loadStore();
      const idx = store.shots.findIndex(x => x.id === editingId);
      if(idx < 0) return;

      store.shots[idx] = {
        ...store.shots[idx],
        date: edit.date.value || store.shots[idx].date,
        bean: (edit.bean.value || "").trim(),
        type: (edit.type.value || "").trim(),
        roast: (edit.roast.value || "").trim(),
        grind: num(edit.grind.value),
        dose: num(edit.dose.value),
        yield: num(edit.yield.value),
        time: num(edit.time.value),
        rating: num(edit.rating.value) || 4
      };

      saveStore(store);
      closeEdit();
      renderAll();
    });

    editDelete.addEventListener("click", () => {
      if(!editingId) return;
      if(!confirm("Delete this shot?")) return;
      const store = loadStore();
      store.shots = store.shots.filter(x => x.id !== editingId);
      saveStore(store);
      closeEdit();
      renderAll();
    });

/* -----------------------------
      Render all
    ------------------------------ */
    function renderAll(){
      renderDashboard(loadStore());
      if(sheet.classList.contains("active")){
        renderWeekSheet(loadStore());
      }
    }

    /* -----------------------------
      PWA SW
    ------------------------------ */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }

    /* -----------------------------
      Init
    ------------------------------ */
    const route = (location.hash || "#cover").replace("#","");
    show(route);
    renderAll();
  </script>

  <!-- Edit Shot Sheet -->
  <div class="sheet" id="edit-sheet" role="dialog" aria-modal="true" aria-label="Edit Shot">
    <div class="sheetpanel">
      <div class="sheethead">
        <div class="sheettitle">EDIT SHOT</div>
        <button class="navbtn" id="edit-close" aria-label="Close">✕</button>
      </div>

      <div class="table" role="table" aria-label="Edit Shot">
        <div class="tr">
          <div class="td label">Date</div>
          <div class="td mono"><input class="field mono" id="e-date" type="date" /></div>
        </div>
        <div class="tr">
          <div class="td label">Bean</div>
          <div class="td mono"><input class="field mono" id="e-bean" /></div>
        </div>
        <div class="tr">
          <div class="td label">Type</div>
          <div class="td mono"><input class="field mono" id="e-type" /></div>
        </div>
        <div class="tr">
          <div class="td label">Roast</div>
          <div class="td mono"><input class="field mono" id="e-roast" /></div>
        </div>
        <div class="tr two">
          <div class="td mono">GRIND<div class="spacer"></div><input class="field mono" id="e-grind" inputmode="numeric"/></div>
          <div class="td mono">DOSE (g)<div class="spacer"></div><input class="field mono" id="e-dose" inputmode="decimal"/></div>
        </div>
        <div class="tr two">
          <div class="td mono">YIELD (ml)<div class="spacer"></div><input class="field mono" id="e-yield" inputmode="decimal"/></div>
          <div class="td mono">TIME (s)<div class="spacer"></div><input class="field mono" id="e-time" inputmode="decimal"/></div>
        </div>
        <div class="tr">
          <div class="td label">Rating</div>
          <div class="td mono">
            <select class="field mono" id="e-rating">
              <option value="5">★★★★★ (Great)</option>
              <option value="4">★★★★☆ (Good)</option>
              <option value="3">★★★☆☆ (Okay)</option>
              <option value="2">★★☆☆☆ (Off)</option>
              <option value="1">★☆☆☆☆ (Bad)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="spacer"></div>
      <div class="row">
        <button class="btn primary" id="edit-save">Save Changes</button>
        <button class="btn" id="edit-delete">Delete</button>
      </div>

      <div class="helper" style="margin-top:10px">Tip: Tap a shot to edit. Long-press/right-click to quick delete.</div>
    </div>
  </div>

</body>
</html>
